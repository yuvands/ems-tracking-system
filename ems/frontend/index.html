<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMS Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Ionicons for nice icons -->
    <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
    <style>
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #a8a8a8; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Modal base styles */
        .modal {
            display: none; /* Hidden by default */
            opacity: 0;
            transition: opacity 0.3s ease-out;
            position: fixed; /* Stay in place */
            inset: 0; /* Cover the whole screen */
            z-index: 50; /* Sit on top */
            background-color: rgba(0, 0, 0, 0.5); /* Dimmed background */
            align-items: center; /* Vertical center */
            justify-content: center; /* Horizontal center */
        }
        .modal.active {
            display: flex; /* Show the modal */
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-72 bg-white shadow-md flex flex-col flex-shrink-0">
            <!-- Logo/Header -->
            <div class="p-5 border-b flex items-center justify-between">
                <div class="flex items-center space-x-2">
                    <span class="text-indigo-600">
                        <ion-icon name="pulse" class="text-3xl"></ion-icon>
                    </span>
                    <h1 class="text-xl font-bold text-gray-800">EMS</h1>
                </div>
            </div>

            <!-- Main Sidebar Content: Manage Ambulances -->
            <div class="p-5 flex-1 overflow-y-auto">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Manage Units</h2>
                    <button id="add-ambulance-btn" class="text-indigo-600 hover:text-indigo-800" title="Add New Ambulance">
                        <ion-icon name="add-circle" class="text-2xl"></ion-icon>
                    </button>
                </div>
                <div id="ambulance-list" class="space-y-3">
                    <p class="text-gray-400">Loading units...</p>
                </div>
            </div>

            <!-- Sidebar Footer -->
            <div class="p-5 border-t">
                <button id="new-incident-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-indigo-700 transition-colors duration-200 flex items-center justify-center space-x-2">
                    <ion-icon name="add-circle" class="text-xl"></ion-icon>
                    <span>New Incident</span>
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <!-- Top Bar -->
            <header class="bg-white border-b border-gray-200 p-4 shadow-sm">
                <h1 class="text-2xl font-bold text-gray-800">Dispatcher Dashboard</h1>
            </header>

            <!-- Main Content Grid -->
            <div class="flex-1 p-6 overflow-y-auto">

                <!-- Active Incidents Section -->
                <div class="mb-4">
                    <h2 class="text-2xl font-semibold text-gray-800">Incidents</h2>
                    <!-- Maybe add filtering later -->
                </div>
                <div id="incident-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="text-center p-5 text-gray-500 col-span-full">Loading incidents...</div>
                </div>

                <!-- Hospitals & Capacity Section -->
                <div class="mt-10 mb-4 flex justify-between items-center">
                    <h2 class="text-2xl font-semibold text-gray-800">Hospitals & Capacity</h2>
                     <button id="add-hospital-btn" class="text-indigo-600 hover:text-indigo-800" title="Add New Hospital">
                        <ion-icon name="add-circle" class="text-2xl"></ion-icon>
                    </button>
                </div>
                <div id="hospital-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="text-center p-5 text-gray-500 col-span-full">Loading hospitals...</div>
                </div>

            </div>
        </main>
    </div>

    <!-- Modals (Placed outside the main flex container for stacking context) -->

    <!-- "New Incident" Modal -->
    <div id="incident-modal" class="modal">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md m-4">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Log New Incident</h2>
            <form id="incident-form">
                <div class="space-y-4">
                    <input type="text" id="patient-name" placeholder="Patient Name (Optional)" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <div class="flex space-x-4">
                        <input type="text" id="latitude" placeholder="Latitude" required class="w-1/2 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <input type="text" id="longitude" placeholder="Longitude" required class="w-1/2 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <textarea id="description" placeholder="Description (e.g., 'Minor head trauma from debris')" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    <select id="ambulance-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="">Assign Ambulance (Optional)</option>
                    </select>
                    <select id="hospital-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="">Assign Hospital (Optional)</option>
                    </select>
                    <div id="incident-form-error" class="text-red-600 text-sm hidden"></div>
                    <div class="flex justify-end space-x-3 pt-4">
                        <button type="button" id="cancel-incident" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">Cancel</button>
                        <button type="submit" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors">Create Incident</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- "View Vitals" Modal -->
    <div id="vitals-modal" class="modal">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg m-4">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">Live Patient Vitals</h2>
                <button id="close-vitals-btn" class="text-gray-500 hover:text-gray-800">
                    <ion-icon name="close-circle" class="text-3xl"></ion-icon>
                </button>
            </div>
            <div id="vitals-content" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                <!-- Vitals content -->
            </div>
        </div>
    </div>

    <!-- "Manage Ambulance" Modal -->
    <div id="ambulance-modal" class="modal">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md m-4">
            <h2 id="ambulance-modal-title" class="text-2xl font-bold mb-6 text-gray-800">Manage Ambulance</h2>
            <form id="ambulance-form">
                <input type="hidden" id="ambulance-id-input" value="">
                <div class="space-y-4">
                    <input type="text" id="ambulance-plate" placeholder="License Plate (e.g., KA-01-AB-1234)" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <select id="ambulance-status" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="available">Available</option>
                        <option value="en_route_to_scene">En Route to Scene</option>
                        <option value="at_scene">At Scene</option>
                        <option value="en_route_to_hospital">En Route to Hospital</option>
                        <option value="unavailable">Unavailable</option>
                        <option value="maintenance_required">Maintenance Required</option>
                    </select>
                    <div class="flex space-x-4">
                        <input type="text" id="ambulance-lat" placeholder="Current Latitude (Optional)" class="w-1/2 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <input type="text" id="ambulance-lon" placeholder="Current Longitude (Optional)" class="w-1/2 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div id="ambulance-form-error" class="text-red-600 text-sm hidden"></div>
                    <div class="flex justify-between items-center pt-4">
                        <div>
                            <button type="button" id="delete-ambulance-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors hidden">
                                Delete
                            </button>
                        </div>
                        <div class="space-x-3">
                            <button type="button" id="cancel-ambulance" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">Cancel</button>
                            <button type="submit" id="save-ambulance-btn" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors">
                                Save
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- "Manage Hospital" Modal -->
     <div id="hospital-modal" class="modal">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg m-4">
            <h2 id="hospital-modal-title" class="text-2xl font-bold mb-6 text-gray-800">Manage Hospital</h2>
            <form id="hospital-form">
                <input type="hidden" id="hospital-id-input" value="">
                <div class="space-y-4">
                    <input type="text" id="hospital-name" placeholder="Hospital Name" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <input type="text" id="hospital-address" placeholder="Address (Optional)" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <div class="flex space-x-4">
                        <input type="text" id="hospital-lat" placeholder="Latitude" required class="w-1/2 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <input type="text" id="hospital-lon" placeholder="Longitude" required class="w-1/2 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="flex space-x-4">
                        <input type="number" id="hospital-er-capacity" placeholder="ER Capacity (Optional)" class="w-1/2 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <input type="number" id="hospital-er-occupancy" placeholder="ER Occupancy (Optional)" class="w-1/2 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div id="hospital-form-error" class="text-red-600 text-sm hidden"></div>
                    <div class="flex justify-between items-center pt-4">
                        <div>
                            <button type="button" id="delete-hospital-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors hidden">
                                Delete
                            </button>
                        </div>
                        <div class="space-x-3">
                            <button type="button" id="cancel-hospital" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">Cancel</button>
                            <button type="submit" id="save-hospital-btn" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors">
                                Save
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- "Manage Incident" Modal -->
    <div id="manage-incident-modal" class="modal">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-lg m-4">
            <h2 id="manage-incident-modal-title" class="text-2xl font-bold mb-6 text-gray-800">Manage Incident</h2>
            <form id="manage-incident-form">
                <input type="hidden" id="manage-incident-id-input" value="">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Patient Info</label>
                        <p id="manage-incident-patient-name" class="mt-1 text-gray-600 text-sm">Loading...</p>
                    </div>
                     <textarea id="manage-incident-description" placeholder="Description" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                     <select id="manage-incident-ambulance-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="">Assign Ambulance (Optional)</option>
                        <!-- Options populated by JS -->
                    </select>
                    <select id="manage-incident-hospital-select" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="">Assign Hospital (Optional)</option>
                        <!-- Options populated by JS -->
                    </select>
                     <select id="manage-incident-status" class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <option value="active">Active</option>
                         <option value="en_route_to_scene">En Route to Scene</option>
                         <option value="at_scene">At Scene</option>
                         <option value="en_route_to_hospital">En Route to Hospital</option>
                        <option value="closed">Closed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                    <div id="manage-incident-form-error" class="text-red-600 text-sm hidden"></div>
                    <!-- Buttons section updated -->
                    <div class="flex justify-between items-center pt-4">
                         <div>
                            <!-- Delete button added -->
                            <button type="button" id="delete-incident-btn" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                                Delete
                            </button>
                        </div>
                        <div class="space-x-3">
                            <button type="button" id="cancel-manage-incident" class="px-6 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-colors">Cancel</button>
                            <button type="submit" id="save-manage-incident-btn" class="px-6 py-2 bg-indigo-600 text-white font-semibold rounded-lg hover:bg-indigo-700 transition-colors">
                                Update Incident
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>


    <!-- Custom Message Box for Errors/Success -->
    <div id="message-box" class="modal">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-sm m-4">
            <h2 id="message-title" class="text-2xl font-bold mb-4 text-gray-800">Message</h2>
            <p id="message-body" class="text-gray-600 mb-6">Something went wrong.</p>
            <button id="message-ok-btn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 transition-colors">
                OK
            </button>
        </div>
    </div>


    <!-- Main JavaScript Logic -->
    <script>
        console.log("Script loaded."); // <-- DEBUG LOG
        // API Base URL
        const API_URL = 'http://127.0.0.1:5000/api';

        // --- All DOM Elements ---
        const ambulanceList = document.getElementById('ambulance-list');
        const incidentGrid = document.getElementById('incident-grid');
        const hospitalGrid = document.getElementById('hospital-grid');
        const newIncidentBtn = document.getElementById('new-incident-btn');
        const incidentModal = document.getElementById('incident-modal');
        const cancelIncidentBtn = document.getElementById('cancel-incident');
        const incidentForm = document.getElementById('incident-form');
        const incidentFormError = document.getElementById('incident-form-error');
        const ambSelect = document.getElementById('ambulance-select');
        const hospSelect = document.getElementById('hospital-select');
        const vitalsModal = document.getElementById('vitals-modal');
        const closeVitalsBtn = document.getElementById('close-vitals-btn');
        const vitalsContent = document.getElementById('vitals-content');

        const addAmbulanceBtn = document.getElementById('add-ambulance-btn');
        const ambulanceModal = document.getElementById('ambulance-modal');
        const ambulanceModalTitle = document.getElementById('ambulance-modal-title');
        const ambulanceForm = document.getElementById('ambulance-form');
        const ambulanceFormError = document.getElementById('ambulance-form-error');
        const ambulanceIdInput = document.getElementById('ambulance-id-input');
        const ambulancePlate = document.getElementById('ambulance-plate');
        const ambulanceStatus = document.getElementById('ambulance-status');
        const ambulanceLat = document.getElementById('ambulance-lat');
        const ambulanceLon = document.getElementById('ambulance-lon');
        const cancelAmbulanceBtn = document.getElementById('cancel-ambulance');
        const deleteAmbulanceBtn = document.getElementById('delete-ambulance-btn');
        const saveAmbulanceBtn = document.getElementById('save-ambulance-btn');

        const addHospitalBtn = document.getElementById('add-hospital-btn');
        const hospitalModal = document.getElementById('hospital-modal');
        const hospitalModalTitle = document.getElementById('hospital-modal-title');
        const hospitalForm = document.getElementById('hospital-form');
        const hospitalFormError = document.getElementById('hospital-form-error');
        const hospitalIdInput = document.getElementById('hospital-id-input');
        const hospitalName = document.getElementById('hospital-name');
        const hospitalAddress = document.getElementById('hospital-address');
        const hospitalLat = document.getElementById('hospital-lat');
        const hospitalLon = document.getElementById('hospital-lon');
        const hospitalErCapacity = document.getElementById('hospital-er-capacity');
        const hospitalErOccupancy = document.getElementById('hospital-er-occupancy');
        const cancelHospitalBtn = document.getElementById('cancel-hospital');
        const deleteHospitalBtn = document.getElementById('delete-hospital-btn');
        const saveHospitalBtn = document.getElementById('save-hospital-btn');

        // Manage Incident Modal Elements
        const manageIncidentModal = document.getElementById('manage-incident-modal');
        const manageIncidentModalTitle = document.getElementById('manage-incident-modal-title');
        const manageIncidentForm = document.getElementById('manage-incident-form');
        const manageIncidentIdInput = document.getElementById('manage-incident-id-input');
        const manageIncidentPatientName = document.getElementById('manage-incident-patient-name');
        const manageIncidentDescription = document.getElementById('manage-incident-description');
        const manageIncidentAmbulanceSelect = document.getElementById('manage-incident-ambulance-select');
        const manageIncidentHospitalSelect = document.getElementById('manage-incident-hospital-select');
        const manageIncidentStatus = document.getElementById('manage-incident-status');
        const manageIncidentFormError = document.getElementById('manage-incident-form-error');
        const cancelManageIncidentBtn = document.getElementById('cancel-manage-incident');
        const saveManageIncidentBtn = document.getElementById('save-manage-incident-btn');
        const deleteIncidentBtn = document.getElementById('delete-incident-btn'); // <-- NEW DELETE BUTTON


        const msgBox = document.getElementById('message-box');
        const msgTitle = document.getElementById('message-title');
        const msgBody = document.getElementById('message-body');
        const msgOkBtn = document.getElementById('message-ok-btn');

        // Global state to store data
        let allAmbulances = [];
        let allHospitals = [];
        let allIncidents = [];

        /** Shows a custom message box */
        function showMessage(title, message) {
            console.log("Showing message:", title, message);
            if (msgTitle && msgBody && msgBox) {
                msgTitle.textContent = title;
                msgBody.textContent = message;
                msgBox.classList.add('active');
            } else { console.error("Message box elements not found!"); }
        }

        /** Hides the custom message box */
        function hideMessageBox() {
            console.log("Hiding message box");
            if (msgBox) { msgBox.classList.remove('active'); }
        }

        /** Fetches all initial data and renders the dashboard */
        async function loadInitialData() {
            console.log("Loading initial data...");
            if (ambulanceList) ambulanceList.innerHTML = '<p class="text-gray-400">Loading units...</p>';
            if (incidentGrid) incidentGrid.innerHTML = '<p class="text-gray-500 col-span-full">Loading incidents...</p>';
            if (hospitalGrid) hospitalGrid.innerHTML = '<p class="text-gray-500 col-span-full">Loading hospitals...</p>';
            try {
                const [ambResponse, incResponse, hospResponse] = await Promise.all([
                    fetch(`${API_URL}/ambulances`),
                    fetch(`${API_URL}/incidents`),
                    fetch(`${API_URL}/hospitals`)
                ]);
                if (!ambResponse.ok || !incResponse.ok || !hospResponse.ok) {
                    throw new Error(`Failed to fetch initial data. Status: ${ambResponse.status}, ${incResponse.status}, ${hospResponse.status}`);
                }
                allAmbulances = await ambResponse.json();
                allIncidents = await incResponse.json();
                allHospitals = await hospResponse.json();
                console.log("Data fetched:", { ambulances: allAmbulances.length, incidents: allIncidents.length, hospitals: allHospitals.length });
                renderAmbulances(allAmbulances);
                renderIncidents(allIncidents);
                renderHospitals(allHospitals);
                populateDropdowns(allAmbulances, allHospitals);
            } catch (error) {
                console.error("Error in loadInitialData:", error);
                showMessage('Network Error', `Failed to connect to the EMS API. ${error.message}`);
                 if (ambulanceList) ambulanceList.innerHTML = '<p class="text-red-500">Failed to load units.</p>';
                 if (incidentGrid) incidentGrid.innerHTML = '<p class="text-red-500 col-span-full">Failed to load incidents.</p>';
                 if (hospitalGrid) hospitalGrid.innerHTML = '<p class="text-red-500 col-span-full">Failed to load hospitals.</p>';
            }
        }

        /** Renders the list of ambulances in the sidebar */
        function renderAmbulances(ambulances) {
            if (!ambulanceList) return;
            ambulanceList.innerHTML = '';
            if (ambulances.length === 0) { ambulanceList.innerHTML = '<p class="text-gray-500">No units in system.</p>'; return; }
            ambulances.sort((a, b) => a.id - b.id);
            ambulances.forEach(amb => {
                let statusColor = 'bg-gray-100 text-gray-800';
                if (amb.status === 'available') statusColor = 'bg-green-100 text-green-800';
                if (amb.status?.includes('en_route')) statusColor = 'bg-blue-100 text-blue-800';
                if (amb.status === 'at_scene') statusColor = 'bg-yellow-100 text-yellow-800';
                if (amb.status === 'unavailable' || amb.status?.includes('maintenance')) statusColor = 'bg-red-100 text-red-800';
                const div = document.createElement('div');
                div.className = "bg-gray-50 p-3 rounded-lg border border-gray-200";
                div.innerHTML = `
                    <div class="flex justify-between items-center"> <span class="font-semibold text-gray-700">${amb.license_plate}</span> <span class="text-xs font-medium ${statusColor} px-2 py-0.5 rounded-full">${amb.status}</span> </div>
                    <div class="text-sm text-gray-500 mt-2 flex justify-between items-center"> <span>ID: ${amb.id}</span> <button class="text-xs text-indigo-600 font-semibold hover:underline manage-ambulance-btn" data-id="${amb.id}">Manage</button> </div>`;
                 const manageBtn = div.querySelector('.manage-ambulance-btn');
                 if (manageBtn) { manageBtn.addEventListener('click', () => openAmbulanceModal(amb.id)); }
                ambulanceList.appendChild(div);
            });
        }

        /** Renders the grid of incidents */
        function renderIncidents(incidents) {
            if (!incidentGrid) return;
            incidentGrid.innerHTML = '';
            if (incidents.length === 0) { incidentGrid.innerHTML = '<p class="text-gray-500 col-span-full">No incidents recorded.</p>'; return; }
            incidents.sort((a, b) => new Date(b.incident_time || 0) - new Date(a.incident_time || 0));
            incidents.forEach(inc => {
                let statusColor = 'bg-gray-100 text-gray-800';
                if (inc.status === 'active') statusColor = 'bg-red-100 text-red-800';
                if (inc.status?.includes('en_route')) statusColor = 'bg-blue-100 text-blue-800';
                if (inc.status === 'at_scene') statusColor = 'bg-yellow-100 text-yellow-800';
                if (inc.status === 'closed') statusColor = 'bg-green-100 text-green-800';
                if (inc.status === 'cancelled') statusColor = 'bg-gray-100 text-gray-500';
                const div = document.createElement('div');
                div.className = "bg-white p-5 rounded-lg shadow-md border border-gray-100 flex flex-col";
                div.innerHTML = `
                    <div class="flex justify-between items-center mb-3"> <h3 class="text-lg font-semibold text-gray-900">Incident #${inc.id}</h3> <span class="text-xs font-medium ${statusColor} px-2 py-0.5 rounded-full">${inc.status}</span> </div>
                    <p class="text-sm text-gray-600 mb-4 truncate flex-grow">${inc.description || 'No description.'}</p>
                    <div class="space-y-2 text-sm text-gray-700 mb-4">
                        <div class="flex items-center space-x-2"><ion-icon name="location-sharp" class="text-indigo-500"></ion-icon><span>${inc.latitude}, ${inc.longitude}</span></div>
                        <div class="flex items-center space-x-2"><ion-icon name="medkit-sharp" class="text-green-500"></ion-icon><span>Unit: ${inc.ambulance_id || 'N/A'}</span></div>
                        <div class="flex items-center space-x-2"><ion-icon name="business-sharp" class="text-blue-500"></ion-icon><span>Dest: ${inc.destination_hospital_id || 'N/A'}</span></div>
                    </div>
                    <div class="mt-auto pt-4 border-t border-gray-100 flex space-x-2">
                        <button class="flex-1 text-indigo-600 font-semibold py-2 px-3 rounded-lg hover:bg-indigo-50 transition-colors text-sm show-vitals-btn" data-id="${inc.id}"> Vitals </button>
                        <button class="flex-1 text-gray-600 font-semibold py-2 px-3 rounded-lg hover:bg-gray-100 transition-colors text-sm manage-incident-btn" data-id="${inc.id}"> Manage </button>
                    </div>`;
                const vitalsBtn = div.querySelector('.show-vitals-btn');
                if(vitalsBtn) { vitalsBtn.addEventListener('click', () => showVitals(inc.id)); }
                const manageBtn = div.querySelector('.manage-incident-btn');
                if(manageBtn) { manageBtn.addEventListener('click', () => openManageIncidentModal(inc.id)); }
                incidentGrid.appendChild(div);
            });
        }

        /** Renders the grid of hospitals */
        function renderHospitals(hospitals) {
            if (!hospitalGrid) return;
            hospitalGrid.innerHTML = '';
            if (!hospitals || hospitals.length === 0) { hospitalGrid.innerHTML = '<p class="text-gray-500 col-span-full">No hospitals found.</p>'; return; }
            hospitals.sort((a, b) => a.id - b.id);
            hospitals.forEach(hospital => {
                let capacityHtml = '<span class="text-xs text-gray-400">Capacity N/A</span>';
                if (hospital.er_capacity != null && hospital.er_current_occupancy != null) {
                    const capacity = parseInt(hospital.er_capacity); const occupancy = parseInt(hospital.er_current_occupancy);
                    let occupancyPercentage = capacity > 0 ? (occupancy / capacity) * 100 : 0;
                    let capacityColor = 'bg-green-100 text-green-800';
                    if (occupancyPercentage > 70) capacityColor = 'bg-yellow-100 text-yellow-800';
                    if (occupancyPercentage >= 90) capacityColor = 'bg-red-100 text-red-800';
                    capacityHtml = `<span class="text-xs font-medium px-2 py-0.5 rounded-full ${capacityColor}">ER: ${occupancy} / ${capacity}</span>`;
                }
                const div = document.createElement('div');
                div.className = "bg-white p-5 rounded-lg shadow-md border border-gray-100";
                div.innerHTML = `
                    <div class="flex justify-between items-start mb-3"> <h3 class="text-lg font-semibold text-gray-900 truncate mr-2">${hospital.name}</h3> ${capacityHtml} </div>
                    <p class="text-sm text-gray-600 truncate">${hospital.address || 'Address not available'}</p>
                    <div class="text-sm text-gray-400 mt-2 flex justify-between items-center"> <div> <span class="font-medium">ID: ${hospital.id}</span> | <span class="text-gray-500">${hospital.latitude}, ${hospital.longitude}</span> </div> <button class="text-xs text-indigo-600 font-semibold hover:underline manage-hospital-btn" data-id="${hospital.id}"> Manage </button> </div>`;
                const manageBtn = div.querySelector('.manage-hospital-btn');
                if(manageBtn) { manageBtn.addEventListener('click', () => openHospitalModal(hospital.id)); }
                hospitalGrid.appendChild(div);
            });
        }

        /** Populates dropdowns in the incident forms */
        function populateDropdowns(ambulances, hospitals, targetAmbDropdown = ambSelect, targetHospDropdown = hospSelect) {
             if (!targetAmbDropdown || !targetHospDropdown) return;
            targetAmbDropdown.innerHTML = '<option value="">Assign Ambulance (Optional)</option>';
            ambulances.forEach(amb => { targetAmbDropdown.innerHTML += `<option value="${amb.id}">${amb.license_plate} (ID: ${amb.id})</option>`; });
            targetHospDropdown.innerHTML = '<option value="">Assign Hospital (Optional)</option>';
            hospitals.forEach(hosp => { targetHospDropdown.innerHTML += `<option value="${hosp.id}">${hosp.name} (ID: ${hosp.id})</option>`; });
        }

        // --- Incident Modal ---
        function showIncidentModal() {
            console.log("showIncidentModal called");
            populateDropdowns(allAmbulances, allHospitals, ambSelect, hospSelect);
            if (incidentForm) incidentForm.reset(); if (incidentFormError) incidentFormError.classList.add('hidden'); if (incidentModal) incidentModal.classList.add('active');
        }
        function hideIncidentModal() { console.log("hideIncidentModal called"); if (incidentModal) incidentModal.classList.remove('active'); }
        async function handleIncidentSubmit(e) {
             console.log("handleIncidentSubmit called"); e.preventDefault();
             if (incidentFormError) incidentFormError.classList.add('hidden');
            const incidentData = {
                patient_name: document.getElementById('patient-name')?.value || null,
                location_lat: document.getElementById('latitude')?.value, location_lon: document.getElementById('longitude')?.value,
                description: document.getElementById('description')?.value || null,
                ambulance_id: ambSelect?.value || null, hospital_id: hospSelect?.value || null, dispatcher_id: 1
            };
            if (!incidentData.location_lat || !incidentData.location_lon) { showMessage("Validation Error", "Latitude and Longitude are required."); return; }
            try {
                const response = await fetch(`${API_URL}/incidents`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(incidentData) });
                if (!response.ok) { const errData = await response.json(); throw new Error(errData.error || `HTTP error! status: ${response.status}`); }
                hideIncidentModal(); showMessage('Success', 'New incident logged.'); loadInitialData();
            } catch (error) { console.error('Error creating incident:', error); if (incidentFormError) { incidentFormError.textContent = `Error: ${error.message}`; incidentFormError.classList.remove('hidden'); } }
        }

        // --- Vitals Modal ---
        async function showVitals(incidentId) {
            console.log("showVitals called for incident ID:", incidentId);
            if (!vitalsContent || !vitalsModal) return;
            vitalsContent.innerHTML = '<p class="text-gray-500">Loading vitals...</p>'; vitalsModal.classList.add('active');
            try {
                const response = await fetch(`${API_URL}/incidents/${incidentId}/vitals`); if (!response.ok) throw new Error(`Failed to fetch vitals. Status: ${response.status}`);
                const vitals = await response.json();
                if (vitals.length === 0) { vitalsContent.innerHTML = '<p class="text-gray-500">No vitals logged.</p>'; return; }
                vitalsContent.innerHTML = ''; vitals.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                vitals.forEach(v => {
                    vitalsContent.innerHTML += `<div class="bg-gray-50 p-4 rounded-lg border border-gray-200"><div class="text-sm text-gray-500 mb-2">${new Date(v.timestamp).toLocaleString()}</div><div class="grid grid-cols-2 gap-2"><div class="font-medium text-gray-700">Heart Rate:</div><div>${v.heart_rate || 'N/A'} bpm</div><div class="font-medium text-gray-700">Blood Pressure:</div><div>${v.blood_pressure_systolic || 'N/A'} / ${v.blood_pressure_diastolic || 'N/A'}</div><div class="font-medium text-gray-700">Oxygen Sat:</div><div>${v.oxygen_saturation || 'N/A'} %</div></div></div>`;
                });
            } catch (error) { console.error("Error in showVitals:", error); vitalsContent.innerHTML = `<p class="text-red-500">Could not load vitals: ${error.message}</p>`; }
        }
        function hideVitalsModal() { console.log("hideVitalsModal called"); if(vitalsModal) vitalsModal.classList.remove('active'); }

        // --- Ambulance Modal ---
        function openAmbulanceModal(ambulanceId = null) {
            console.log("openAmbulanceModal called with ID:", ambulanceId);
            if (!ambulanceForm || !ambulanceFormError || !ambulanceModal || !ambulanceIdInput || !ambulancePlate || !ambulanceStatus || !ambulanceLat || !ambulanceLon || !deleteAmbulanceBtn || !saveAmbulanceBtn || !ambulanceModalTitle) return;
            ambulanceForm.reset(); ambulanceFormError.classList.add('hidden');
            if (ambulanceId) {
                const ambulance = allAmbulances.find(a => a.id === ambulanceId); if (!ambulance) { showMessage('Error', `Ambulance ID ${ambulanceId} not found`); return; }
                ambulanceModalTitle.textContent = 'Manage Ambulance'; ambulanceIdInput.value = ambulance.id; ambulancePlate.value = ambulance.license_plate; ambulanceStatus.value = ambulance.status;
                ambulanceLat.value = ambulance.latitude || ''; ambulanceLon.value = ambulance.longitude || ''; deleteAmbulanceBtn.classList.remove('hidden'); saveAmbulanceBtn.textContent = 'Update';
            } else {
                ambulanceModalTitle.textContent = 'Add New Ambulance'; ambulanceIdInput.value = ''; deleteAmbulanceBtn.classList.add('hidden'); saveAmbulanceBtn.textContent = 'Save';
            }
            ambulanceModal.classList.add('active');
        }
        function hideAmbulanceModal() { console.log("hideAmbulanceModal called"); if (ambulanceModal) ambulanceModal.classList.remove('active'); }
        async function handleAmbulanceSubmit(e) {
            console.log("handleAmbulanceSubmit called"); e.preventDefault(); if(ambulanceFormError) ambulanceFormError.classList.add('hidden');
            const ambulanceId = ambulanceIdInput?.value; const isUpdate = !!ambulanceId;
            const data = { license_plate: ambulancePlate?.value, status: ambulanceStatus?.value, latitude: ambulanceLat?.value || null, longitude: ambulanceLon?.value || null };
            if (!data.license_plate) { showMessage("Validation Error", "License Plate is required."); return; }
            const url = isUpdate ? `${API_URL}/ambulances/${ambulanceId}` : `${API_URL}/ambulances`; const method = isUpdate ? 'PUT' : 'POST';
            try {
                const response = await fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if (!response.ok) { const errData = await response.json(); throw new Error(errData.error || `HTTP error! status: ${response.status}`); }
                hideAmbulanceModal(); showMessage('Success', `Ambulance ${isUpdate ? 'updated' : 'added'}.`); loadInitialData();
            } catch (error) { console.error('Error saving ambulance:', error); if(ambulanceFormError){ ambulanceFormError.textContent = `Error: ${error.message}`; ambulanceFormError.classList.remove('hidden');} }
        }
        async function handleAmbulanceDelete() {
            console.log("handleAmbulanceDelete called"); const ambulanceId = ambulanceIdInput?.value; if (!ambulanceId) return;
            try {
                const response = await fetch(`${API_URL}/ambulances/${ambulanceId}`, { method: 'DELETE' });
                if (!response.ok && response.status !== 204) {
                    let errorMsg = `HTTP error! status: ${response.status}`;
                    try { const errData = await response.json(); errorMsg = errData.error || errorMsg; } catch (e) { /* Ignore */ } throw new Error(errorMsg);
                }
                hideAmbulanceModal(); showMessage('Success', `Ambulance ID ${ambulanceId} deleted.`); loadInitialData();
            } catch (error) { console.error('Error deleting ambulance:', error); if(ambulanceFormError){ ambulanceFormError.textContent = `Error: ${error.message}`; ambulanceFormError.classList.remove('hidden');} }
        }

        // --- Hospital Modal ---
        function openHospitalModal(hospitalId = null) {
            console.log("openHospitalModal called with ID:", hospitalId);
             if (!hospitalForm || !hospitalFormError || !hospitalModal || !hospitalIdInput || !hospitalName || !hospitalAddress || !hospitalLat || !hospitalLon || !hospitalErCapacity || !hospitalErOccupancy || !deleteHospitalBtn || !saveHospitalBtn || !hospitalModalTitle) return;
            hospitalForm.reset(); hospitalFormError.classList.add('hidden');
            if (hospitalId) {
                const hospital = allHospitals.find(h => h.id === hospitalId); if (!hospital) { showMessage('Error', `Hospital ID ${hospitalId} not found`); return; }
                hospitalModalTitle.textContent = 'Manage Hospital'; hospitalIdInput.value = hospital.id; hospitalName.value = hospital.name; hospitalAddress.value = hospital.address || '';
                hospitalLat.value = hospital.latitude || ''; hospitalLon.value = hospital.longitude || ''; hospitalErCapacity.value = hospital.er_capacity || ''; hospitalErOccupancy.value = hospital.er_current_occupancy || '';
                deleteHospitalBtn.classList.remove('hidden'); saveHospitalBtn.textContent = 'Update';
            } else {
                hospitalModalTitle.textContent = 'Add New Hospital'; hospitalIdInput.value = ''; deleteHospitalBtn.classList.add('hidden'); saveHospitalBtn.textContent = 'Save';
            }
            hospitalModal.classList.add('active');
        }
        function hideHospitalModal() { console.log("hideHospitalModal called"); if (hospitalModal) hospitalModal.classList.remove('active'); }
        async function handleHospitalSubmit(e) {
            console.log("handleHospitalSubmit called"); e.preventDefault(); if (hospitalFormError) hospitalFormError.classList.add('hidden');
            const hospitalId = hospitalIdInput?.value; const isUpdate = !!hospitalId;
            const data = {
                name: hospitalName?.value, address: hospitalAddress?.value || null, latitude: hospitalLat?.value, longitude: hospitalLon?.value,
                er_capacity: hospitalErCapacity?.value || null, er_current_occupancy: hospitalErOccupancy?.value || null
            };
            if (!data.name || !data.latitude || !data.longitude) { showMessage("Validation Error", "Name, Latitude, and Longitude are required."); return; }
            const url = isUpdate ? `${API_URL}/hospitals/${hospitalId}` : `${API_URL}/hospitals`; const method = isUpdate ? 'PUT' : 'POST';
            try {
                const response = await fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if (!response.ok) { const errData = await response.json(); throw new Error(errData.error || `HTTP error! status: ${response.status}`); }
                hideHospitalModal(); showMessage('Success', `Hospital ${isUpdate ? 'updated' : 'added'}.`); loadInitialData();
            } catch (error) { console.error('Error saving hospital:', error); if (hospitalFormError) { hospitalFormError.textContent = `Error: ${error.message}`; hospitalFormError.classList.remove('hidden'); } }
        }
         async function handleHospitalDelete() {
             console.log("handleHospitalDelete called"); const hospitalId = hospitalIdInput?.value; if (!hospitalId) return;
            try {
                const response = await fetch(`${API_URL}/hospitals/${hospitalId}`, { method: 'DELETE' });
                if (!response.ok && response.status !== 204) {
                    let errorMsg = `HTTP error! status: ${response.status}`;
                    try { const errData = await response.json(); errorMsg = errData.error || errorMsg; } catch(e) { /* Ignore */ } throw new Error(errorMsg);
                }
                hideHospitalModal(); showMessage('Success', `Hospital ID ${hospitalId} deleted.`); loadInitialData();
            } catch (error) { console.error('Error deleting hospital:', error); if (hospitalFormError) { hospitalFormError.textContent = `Error: ${error.message}`; hospitalFormError.classList.remove('hidden'); } }
        }

        // --- Manage Incident Modal ---
        async function openManageIncidentModal(incidentId = null) {
            console.log("openManageIncidentModal called with ID:", incidentId);
             if (!manageIncidentForm || !manageIncidentFormError || !manageIncidentModal || !manageIncidentIdInput || !manageIncidentPatientName || !manageIncidentDescription || !manageIncidentAmbulanceSelect || !manageIncidentHospitalSelect || !manageIncidentStatus || !cancelManageIncidentBtn || !saveManageIncidentBtn || !manageIncidentModalTitle || !deleteIncidentBtn) { // Added deleteIncidentBtn check
                 console.error("One or more manage incident modal elements not found!"); return;
             }
            manageIncidentForm.reset(); manageIncidentFormError.classList.add('hidden');
            const incident = allIncidents.find(inc => inc.id === incidentId);
            if (!incident) { showMessage('Error', `Incident ID ${incidentId} not found.`); return; }
             manageIncidentPatientName.textContent = `Patient ID: ${incident.patient_id}`; // Simplified
            manageIncidentModalTitle.textContent = `Manage Incident #${incident.id}`;
            manageIncidentIdInput.value = incident.id;
            manageIncidentDescription.value = incident.description || '';
            manageIncidentStatus.value = incident.status || 'active';
            populateDropdowns(allAmbulances, allHospitals, manageIncidentAmbulanceSelect, manageIncidentHospitalSelect);
            manageIncidentAmbulanceSelect.value = incident.ambulance_id || '';
            manageIncidentHospitalSelect.value = incident.destination_hospital_id || '';
            manageIncidentModal.classList.add('active');
        }
        function hideManageIncidentModal() {
            console.log("hideManageIncidentModal called");
             if (manageIncidentModal) manageIncidentModal.classList.remove('active');
        }
        async function handleManageIncidentSubmit(e) {
            console.log("handleManageIncidentSubmit called");
            e.preventDefault(); if(manageIncidentFormError) manageIncidentFormError.classList.add('hidden');
            const incidentId = manageIncidentIdInput?.value; if (!incidentId) { showMessage("Error", "Incident ID missing."); return; }
            const data = {
                description: manageIncidentDescription?.value || null,
                ambulance_id: manageIncidentAmbulanceSelect?.value || null,
                hospital_id: manageIncidentHospitalSelect?.value || null,
                status: manageIncidentStatus?.value
            };
            const url = `${API_URL}/incidents/${incidentId}`; const method = 'PUT';
            try {
                const response = await fetch(url, { method: method, headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
                if (!response.ok) { const errData = await response.json(); throw new Error(errData.error || `HTTP error! status: ${response.status}`); }
                hideManageIncidentModal(); showMessage('Success', `Incident #${incidentId} updated.`); loadInitialData();
            } catch (error) { console.error('Error updating incident:', error); if(manageIncidentFormError) { manageIncidentFormError.textContent = `Error: ${error.message}`; manageIncidentFormError.classList.remove('hidden');} }
        }
        // --- Incident Delete Function ---
        async function handleIncidentDelete() {
            console.log("handleIncidentDelete called");
            const incidentId = manageIncidentIdInput?.value; if (!incidentId) return;
            // No confirmation prompt for simplicity here, add one if needed
            try {
                const response = await fetch(`${API_URL}/incidents/${incidentId}`, { method: 'DELETE' });
                if (!response.ok && response.status !== 204) {
                    let errorMsg = `HTTP error! status: ${response.status}`;
                    try { const errData = await response.json(); errorMsg = errData.error || errorMsg; } catch(e) { /* Ignore */ }
                    throw new Error(errorMsg);
                }
                hideManageIncidentModal(); showMessage('Success', `Incident ID ${incidentId} deleted.`); loadInitialData();
            } catch (error) {
                console.error('Error deleting incident:', error);
                if(manageIncidentFormError) { manageIncidentFormError.textContent = `Error: ${error.message}`; manageIncidentFormError.classList.remove('hidden');}
                else { showMessage('Error', `Could not delete incident: ${error.message}`); }
            }
        }

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM fully loaded. Attaching event listeners...");
            try {
                if (newIncidentBtn) newIncidentBtn.addEventListener('click', showIncidentModal); else console.warn("newIncidentBtn not found");
                if (cancelIncidentBtn) cancelIncidentBtn.addEventListener('click', hideIncidentModal); else console.warn("cancelIncidentBtn not found");
                if (incidentForm) incidentForm.addEventListener('submit', handleIncidentSubmit); else console.warn("incidentForm not found");

                if (closeVitalsBtn) closeVitalsBtn.addEventListener('click', hideVitalsModal); else console.warn("closeVitalsBtn not found");

                if (addAmbulanceBtn) addAmbulanceBtn.addEventListener('click', () => openAmbulanceModal(null)); else console.warn("addAmbulanceBtn not found");
                if (cancelAmbulanceBtn) cancelAmbulanceBtn.addEventListener('click', hideAmbulanceModal); else console.warn("cancelAmbulanceBtn not found");
                if (ambulanceForm) ambulanceForm.addEventListener('submit', handleAmbulanceSubmit); else console.warn("ambulanceForm not found");
                if (deleteAmbulanceBtn) deleteAmbulanceBtn.addEventListener('click', handleAmbulanceDelete); else console.warn("deleteAmbulanceBtn not found");

                if (addHospitalBtn) addHospitalBtn.addEventListener('click', () => openHospitalModal(null)); else console.warn("addHospitalBtn not found");
                if (cancelHospitalBtn) cancelHospitalBtn.addEventListener('click', hideHospitalModal); else console.warn("cancelHospitalBtn not found");
                if (hospitalForm) hospitalForm.addEventListener('submit', handleHospitalSubmit); else console.warn("hospitalForm not found");
                if (deleteHospitalBtn) deleteHospitalBtn.addEventListener('click', handleHospitalDelete); else console.warn("deleteHospitalBtn not found");

                 // Manage Incident Listeners
                if (cancelManageIncidentBtn) cancelManageIncidentBtn.addEventListener('click', hideManageIncidentModal); else console.warn("cancelManageIncidentBtn not found");
                if (manageIncidentForm) manageIncidentForm.addEventListener('submit', handleManageIncidentSubmit); else console.warn("manageIncidentForm not found");
                if (deleteIncidentBtn) deleteIncidentBtn.addEventListener('click', handleIncidentDelete); else console.warn("deleteIncidentBtn not found"); // <-- NEW LISTENER

                if (msgOkBtn) msgOkBtn.addEventListener('click', hideMessageBox); else console.warn("msgOkBtn not found");

                console.log("Event listeners attached.");
                 loadInitialData(); // Load data *after* listeners are set up
            } catch (error) {
                console.error("Error attaching event listeners:", error);
                showMessage("Initialization Error", "Could not set up the page interactions.");
            }
        });

    </script>
</body>
</html>

